<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>HTML me! Studio</title>

    <!-- UI Framework -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FONT AWESOME -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;800&family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Capture Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-deep: #0B0F19;
            --bg-panel: rgba(20, 25, 40, 0.75);
            --accent-primary: #3B82F6;
            --accent-secondary: #8B5CF6;
            --text-main: #E2E8F0;
            --text-muted: #94a3b8;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(20px);
            --hud-bg: rgba(20, 25, 40, 0.75);
            --hud-text: #E2E8F0;
        }

        body.theme-aurora { --bg-deep: #0f0c29; --bg-panel: rgba(255, 255, 255, 0.1); --accent-primary: #ec4899; --accent-secondary: #6366f1; --border-subtle: rgba(255, 255, 255, 0.2); --glass-blur: blur(15px); }
        body.theme-pearl { --bg-deep: #fdfbf7; --bg-panel: rgba(255, 255, 255, 0.65); --accent-primary: #8b5cf6; --accent-secondary: #d4af37; --text-main: #1e293b; --text-muted: #64748b; --border-subtle: rgba(0, 0, 0, 0.06); --glass-blur: blur(25px); --hud-bg: rgba(255, 255, 255, 0.85); --hud-text: #334155; }

        body { 
            background-color: var(--bg-deep); color: var(--text-main); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            min-height: 100vh; overflow-x: hidden; margin: 0; display: flex; 
            transition: all 0.5s ease; -webkit-font-smoothing: antialiased; 
        }

        .bg-layer { position: absolute; inset: 0; pointer-events: none; transition: opacity 0.8s ease; z-index: 0; }
        .bg-obsidian { background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.1), transparent 40%), radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1), transparent 30%); opacity: 0; }
        .bg-aurora { background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #1a1a2e); background-size: 400% 400%; animation: auroraBG 15s ease infinite; opacity: 0; }
        .bg-pearl { background: linear-gradient(135deg, #fdfbf7 0%, #f3e8ff 50%, #fffbeb 100%); opacity: 0; }
        .bg-pearl::after { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15), transparent 50%), radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.15), transparent 50%); }

        body.theme-obsidian .bg-obsidian, body.theme-aurora .bg-aurora, body.theme-pearl .bg-pearl { opacity: 1; }
        @keyframes auroraBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Sidebar & Stage */
        .sidebar { width: 380px; background: var(--bg-panel); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; padding: 1.5rem; z-index: 50; flex-shrink: 0; box-shadow: 10px 0 40px rgba(0,0,0,0.05); height: 100vh; overflow-y: auto; transition: all 0.3s ease; -webkit-overflow-scrolling: touch; }
        .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-subtle); display: flex; flex-direction: column; gap: 10px; }

        .stage-container { 
            flex-grow: 1; position: relative; z-index: 10; 
            background: rgba(0, 0, 0, 0.05); 
            background-image: linear-gradient(var(--border-subtle) 1px, transparent 1px), linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px); 
            background-size: 50px 50px; 
            height: 100vh; 
            overflow: hidden; /* Changed to hidden for custom pan/zoom */
            display: flex; justify-content: center; align-items: center;
            touch-action: none; /* Handle touches manually */
        }

        #render-wrapper {
            transform-origin: center center;
            transition: transform 0.1s ease-out;
            will-change: transform;
        }

        #render-target { background-color: white; color: black; box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 50px 100px -20px rgba(0, 0, 0, 0.3); min-height: 400px; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; position: relative; transform-style: flat; }
        #render-target * { transform-origin: top left; }

        /* UI Elements */
        .control-group { margin-bottom: 1.5rem; }
        .control-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        #html-input { width: 100%; min-height: 180px; background-color: rgba(0, 0, 0, 0.05); color: var(--accent-primary); font-family: 'JetBrains Mono', monospace; font-size: 11px; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1rem; resize: vertical; outline: none; transition: border-color 0.3s; line-height: 1.5; }
        body.theme-pearl #html-input { background-color: rgba(255,255,255,0.5); color: #475569; }
        #html-input:focus { border-color: var(--accent-primary); background-color: rgba(125,125,125,0.1); }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--text-main); cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(125,125,125,0.5); border: 2px solid var(--accent-primary); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); border-radius: 2px; }

        #hud-toolbar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%); background: var(--hud-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-subtle); padding: 10px 20px; border-radius: 50px; display: flex; gap: 12px; align-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.15); z-index: 100; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #hud-toolbar.visible { transform: translateX(-50%) translateY(0); }
        .hud-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(125,125,125,0.1); border: 1px solid var(--border-subtle); color: var(--hud-text); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; position: relative; }
        .hud-btn:hover { background: var(--accent-primary); transform: scale(1.1); color: white; border-color: transparent; }
        .hud-btn.danger:hover { color: white; background: #ef4444; }
        .hidden-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .btn-secondary { background: rgba(125, 125, 125, 0.1); color: var(--text-muted); transition: all 0.2s; }
        .btn-secondary:hover { background: rgba(125, 125, 125, 0.2); color: var(--text-main); }

        .editing-active #render-target { outline: 4px solid var(--accent-primary); outline-offset: 2px; }
        .selectable-hover { outline: 1px dashed var(--accent-primary); cursor: move; touch-action: none; }
        .selected-element { outline: 2px solid var(--accent-primary) !important; position: relative; z-index: 100; }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--accent-primary); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; opacity: 0; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #resolution-warning { display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 10px; margin-top: 10px; color: #fca5a5; font-size: 10px; align-items: start; gap: 8px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === GLOBAL OVERLAYS === */
        .trick-overlay { position: fixed; inset: 0; z-index: 9999999; display: none; width: 100vw; height: 100vh; overflow: hidden; cursor: none; }

        /* REBOOT TRICK */
        #global-boot-screen { background-color: #000; color: #10b981; font-family: 'Courier New', monospace; }
        #bsod-screen { background-color: #0078D7; color: white; font-family: 'Segoe UI', sans-serif; padding: 10% 15%; display: none; flex-direction: column; height: 100%; width: 100%; position: absolute; top: 0; left: 0; }
        .sad-face { font-size: 100px; margin-bottom: 30px; }
        .bsod-title { font-size: 24px; margin-bottom: 20px; font-weight: 300; }
        .bios-text { margin-bottom: 5px; text-shadow: 0 0 5px #10b981; padding-left: 20px; }
        .bios-header { padding: 20px; margin-bottom: 10px; }

        /* FAILURE TRICK */
        #global-fail-screen { background-color: #000; color: #ef4444; font-family: 'Share Tech Mono', monospace; text-transform: uppercase; }
        .red-strobe { animation: strobe 0.1s infinite; }
        @keyframes strobe { 0% { background: #000; } 50% { background: #200; } 100% { background: #000; } }
        .fail-text { font-size: 2rem; text-align: center; animation: shake 0.5s infinite; text-shadow: 2px 2px 0px #000; }

        /* GAME UI */
        #global-game-screen { background-color: #0f172a; font-family: 'JetBrains Mono', monospace; cursor: crosshair; touch-action: none; }

        /* GAME TARGETS (Hexagons -> Circles) */
        .game-target, .decoy-target, .bonus-target { 
            position: absolute; width: 80px; height: 80px; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; border: 3px solid #fff;
            animation: popIn 0.2s ease-out;
            border-radius: 50%; /* Changed to Circle */
        }

        /* TARGET (Starts Red) */
        .game-target {
            background: radial-gradient(circle, #ef4444 0%, #7f1d1d 100%);
            box-shadow: 0 0 25px #ef4444;
            /* Updated decayColor to 1.2s */
            animation: popIn 0.2s, decayColor 1.2s forwards linear; 
        }
        .game-target i { font-size: 32px; color: white; }

        /* ROTTEN TARGET (Yellow - Dangerous) */
        .game-target.rotten {
            background: radial-gradient(circle, #f59e0b 0%, #92400e 100%);
            box-shadow: 0 0 25px #f59e0b; border-color: #fcd34d;
        }
        .game-target.rotten i { color: #fffbeb; }

        /* DECOY (Blue Bolt - Don't Touch) */
        .decoy-target {
            background: radial-gradient(circle, #3b82f6 0%, #1e3a8a 100%);
            box-shadow: 0 0 30px #38bdf8; border-color: #e0f2fe;
        }
        .decoy-target i { font-size: 32px; color: #ffffff; filter: drop-shadow(0 0 5px #0ea5e9); }

        /* BONUS (Diamond) */
        .bonus-target {
            background: radial-gradient(circle, #06b6d4 0%, #164e63 100%);
            box-shadow: 0 0 30px #22d3ee; border-color: #cffafe;
            animation: popIn 0.2s, pulseGem 0.5s infinite alternate;
        }
        .bonus-target i { font-size: 32px; color: #ffffff; text-shadow: 0 0 10px white; }

        @keyframes decayColor { 
            0% { filter: hue-rotate(0deg); } 
            70% { filter: hue-rotate(0deg); } 
            100% { filter: hue-rotate(45deg); } 
        }
        @keyframes pulseGem { from { transform: scale(1); } to { transform: scale(1.1); } }

        .game-target.hit, .bonus-target.hit { animation: popOut 0.1s forwards; filter: hue-rotate(120deg) !important; }
        .frag-particle { position: absolute; width: 6px; height: 6px; background: #10b981; border-radius: 50%; pointer-events: none; animation: explode 0.5s forwards; }

        @keyframes explode { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes popOut { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes shakeTimer { 0% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); color: #ef4444; } 50% { transform: translate(2px, -2px); } 75% { transform: translate(-2px, -2px); } 100% { transform: translate(0, 0); } }
        .timer-critical { animation: shakeTimer 0.1s infinite; color: #ef4444; text-shadow: 0 0 15px #ef4444; font-weight: 900; }

        .shake-screen { animation: violent-shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes violent-shake { 
            10%, 90% { transform: translate3d(-5px, 0, 0); } 
            20%, 80% { transform: translate3d(10px, 0, 0); } 
            30%, 50%, 70% { transform: translate3d(-10px, 0, 0); } 
            40%, 60% { transform: translate3d(10px, 0, 0); } 
        }

        /* Briefing Icons */
        .briefing-icon { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 3px solid white; }

        @media (max-width: 1024px) { body { flex-direction: column; height: auto; overflow: auto; } .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-subtle); } .stage-container { height: 70vh; padding: 0; align-items: center; overflow: hidden; } #hud-toolbar { width: 95%; justify-content: flex-start; overflow-x: auto; padding: 10px; bottom: 10px; } }
    </style>
</head>
<body class="theme-aurora">

    <!-- 1. REBOOT TRICK OVERLAY -->
    <div id="global-boot-screen" class="trick-overlay">
        <div id="bsod-screen">
            <div class="sad-face">:(</div>
            <div class="bsod-title">Your device ran into a problem and needs to restart. We're just collecting some error info, and then we'll restart for you.</div>
            <div class="bsod-title"><span id="bsod-progress">0</span>% complete</div>
            <div class="flex items-center gap-4 mt-8">
                <div class="bg-white w-24 h-24 flex items-center justify-center p-1">
                    <div class="w-full h-full bg-black" style="mask-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMCAxMCI+PHBhdGggZD0iTTAgMGgxdjFIMHptMiAwaDF2MUgyem00IDBoMXYxSDZ6bTIgMGgxdjFIOHptLTYgMmgydjJIMGV6IiBmaWxsPSIjMDAwIi8+PC9zdmc+'); -webkit-mask-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMCAxMCI+PHBhdGggZD0iTTAgMGgxdjFIMHptMiAwaDF2MUgyem00IDBoMXYxSDZ6bTIgMGgxdjFIOHptLTYgMmgydjJIMGV6IiBmaWxsPSIjMDAwIi8+PC9zdmc+'); mask-size: cover;"></div>
                </div>
                <div class="text-sm">
                    <p>Stop code: CRITICAL_QUANTUM_DECOHERENCE</p>
                </div>
            </div>
        </div>
        <div id="bios-screen" style="display:none; height:100%; padding:20px;">
            <div class="bios-header">
                <div style="color:#fff;">NEXUS QUANTUM BIOS v15.0.0</div>
                <div style="color:#aaa;">Copyright (C) 2025 Nexus Corp.</div>
            </div>
            <div id="boot-log" class="space-y-1 text-emerald-500"></div>
            <div class="mt-2 text-white"><span class="terminal-cursor"></span></div>
        </div>
    </div>

    <!-- 2. FAILURE TRICK OVERLAY -->
    <div id="global-fail-screen" class="trick-overlay">
        <div class="absolute inset-0 red-strobe"></div>
        <div class="relative z-10 flex flex-col items-center justify-center h-full gap-8 p-4">
            <i class="fas fa-radiation text-9xl text-red-500 animate-pulse"></i>
            <div class="fail-text text-red-500 font-black glitch-text" style="font-size:3rem;">
                SYSTEM FAILURE<br>BREACH DETECTED
            </div>
            <div class="w-full max-w-md bg-red-900/30 border border-red-500 h-6 rounded overflow-hidden">
                <div id="restore-bar" class="h-full bg-red-500 w-0 transition-all duration-[5000ms] ease-linear"></div>
            </div>
            <div class="text-red-400 text-sm font-mono animate-pulse" id="fail-log">INITIATING EMERGENCY PURGE...</div>
        </div>
        <div class="absolute inset-0 pointer-events-none opacity-30" style="background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHRleHQgeD0iMCIgeT0iMTUiIGZpbGw9InJlZCIgZm9udC1mYW1pbHQ9Im1vbm9zcGFjZSI+MHg0RjwvdGV4dD48L3N2Zz4=')"></div>
    </div>

    <!-- 3. GAME OVERLAY -->
    <div id="global-game-screen" class="trick-overlay">
        <div class="absolute inset-0 bg-[linear-gradient(rgba(6,182,212,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(6,182,212,0.1)_1px,transparent_1px)] bg-[size:50px_50px] pointer-events-none"></div>

        <div class="panic-overlay" id="panic-flash"></div>

        <!-- BRIEFING OVERLAY -->
        <div id="game-briefing" class="absolute inset-0 flex flex-col items-center justify-center z-50 bg-black/90 backdrop-blur-lg">
            <h1 class="text-4xl font-bold text-white mb-8 tracking-tighter">PROTOCOL: BREACH</h1>
            <div class="flex gap-8 mb-10 flex-wrap justify-center">
                <div class="flex flex-col items-center">
                    <div class="briefing-icon bg-red-500 shadow-[0_0_20px_red] mb-4"><i class="fas fa-bug text-3xl text-white"></i></div>
                    <span class="text-red-400 font-bold tracking-widest">DESTROY</span>
                    <span class="text-xs text-slate-400 mt-1">(Before Yellow)</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="briefing-icon bg-blue-600 shadow-[0_0_20px_cyan] mb-4"><i class="fas fa-bolt text-3xl text-white"></i></div>
                    <span class="text-cyan-400 font-bold tracking-widest">AVOID</span>
                    <span class="text-xs text-slate-400 mt-1">(Decoy)</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="briefing-icon bg-cyan-500 shadow-[0_0_20px_cyan] mb-4 animate-pulse"><i class="fas fa-gem text-3xl text-white"></i></div>
                    <span class="text-cyan-300 font-bold tracking-widest">BONUS</span>
                </div>
            </div>
            <div class="text-8xl font-black text-white animate-pulse" id="briefing-countdown">3</div>
        </div>

        <!-- HUD -->
        <div class="absolute top-0 left-0 p-6 w-full flex justify-between items-start z-40 pointer-events-none">
            <div class="pointer-events-auto">
                <div class="text-4xl font-black text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.8)]" id="game-score">000</div>
                <div class="text-sm text-cyan-400 uppercase tracking-widest">Target: <span class="text-white">1500</span></div>
                <!-- Breach Bar -->
                <div class="mt-2 w-48 h-3 bg-slate-800 border border-red-900 rounded overflow-hidden relative">
                    <div id="breach-bar" class="h-full bg-red-600 w-0 transition-all duration-300"></div>
                </div>
                <div class="text-[10px] text-red-500 uppercase mt-1">System Integrity</div>
            </div>
            <div class="text-center">
                <div class="text-6xl font-black text-white drop-shadow-[0_0_15px_rgba(239,68,68,0.8)]" id="game-timer">15</div>
                <div class="text-sm text-red-400 uppercase tracking-widest">Seconds</div>
            </div>
            <div class="pointer-events-auto">
                <button onclick="window.demoApp.quitGame()" class="px-4 py-2 bg-red-600/20 border border-red-500 text-red-500 rounded hover:bg-red-600 hover:text-white">ABORT</button>
            </div>
        </div>

        <!-- Game Canvas -->
        <div id="game-area" class="absolute inset-0 overflow-hidden touch-none z-30"></div>

        <!-- Result Screen -->
        <div id="game-result-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-black/90 z-50 hidden">
            <h1 id="result-title" class="text-5xl font-black mb-2 animate-bounce"></h1>
            <p class="text-xl text-white mb-6">CORE STATUS: <span id="core-status"></span></p>

            <!-- Leaderboard -->
            <div class="bg-slate-800/80 border border-slate-600 p-6 rounded-xl w-80 mb-8 backdrop-blur-md shadow-2xl">
                <h3 class="text-cyan-400 font-bold text-center mb-4 tracking-widest border-b border-slate-600 pb-2">SECURITY LOG</h3>
                <div id="leaderboard-list" class="space-y-2 font-mono text-sm"></div>
            </div>

            <div class="flex gap-4">
                <button id="btn-retry" onclick="window.demoApp.handleRetry()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-[0_0_15px_rgba(37,99,235,0.6)]">RETRY</button>
                <button id="btn-fate" onclick="window.demoApp.handleFate()" class="px-6 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg border border-red-500 hidden">ACCEPT FATE</button>
                <button id="btn-exit" onclick="window.demoApp.quitGame()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg border border-slate-500">EXIT</button>
            </div>
        </div>
    </div>

    <div class="bg-layer bg-obsidian"></div>
    <div class="bg-layer bg-aurora"></div>
    <div class="bg-layer bg-pearl"></div>

    <div id="toast">Action</div>

    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-semibold text-white">Rendering <span id="render-format-text"></span></h2>
        <p class="text-sm text-white/60 mt-2">Baking Fonts & Vectors...</p>
    </div>

    <!-- Sidebar -->
    <div class="sidebar custom-scrollbar">
        <div class="app-header">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-blue-500 to-violet-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-layer-group text-white text-xs"></i>
                </div>
                <span class="logo-text" style="color: var(--text-main)">HTML me!</span>
            </div>
        </div>

        <div class="bg-slate-500/10 p-1 rounded-lg flex mb-6 border border-white/5">
            <button id="btn-view" onclick="setMode('view')" class="flex-1 py-2 text-xs font-bold rounded shadow-sm transition-all">VIEW</button>
            <button id="btn-edit" onclick="setMode('edit')" class="flex-1 py-2 text-xs font-bold rounded transition-all">EDIT</button>
        </div>

        <div class="control-group">
            <div class="control-label">
                <span>Source Code</span>
                <div class="flex gap-2">
                    <button onclick="pasteCode()" class="text-xs text-blue-400 hover:text-blue-300"><i class="fas fa-paste mr-1"></i>Paste</button>
                    <button onclick="clearCode()" class="text-xs text-red-400 hover:text-red-300"><i class="fas fa-trash mr-1"></i>Clear</button>
                </div>
            </div>
            <textarea id="html-input" placeholder="<!-- HTML goes here -->" spellcheck="false"></textarea>
        </div>

        <div class="control-group">
            <div class="control-label">
                <span>Canvas Width</span>
                <span id="width-val" class="font-mono text-[10px] bg-white/10 px-2 rounded" style="color:var(--text-main)">1000px</span>
            </div>
            <div class="flex gap-3 items-center">
                <input type="range" id="width-slider" min="300" max="3000" step="10" value="1000">
                <button onclick="autoFit()" class="btn-secondary w-8 h-8 rounded flex items-center justify-center border border-white/5"><i class="fas fa-compress-arrows-alt text-xs"></i></button>
            </div>
        </div>

        <div class="control-group">
            <div class="control-label"><span>Scale (1K - 12K)</span><span id="quality-val" style="color:var(--accent-primary)" class="font-bold text-xs">2K</span></div>
            <input type="range" id="quality-slider" min="1" max="12" step="1" value="2">

            <div id="resolution-warning" class="flex">
                <i class="fas fa-exclamation-triangle mt-0.5"></i>
                <div><strong>High Memory Usage</strong><br>10K+ resolution may cause browser freeze.</div>
            </div>
        </div>

        <!-- Export Grid -->
        <div class="grid grid-cols-4 gap-2 mt-4">
            <button onclick="exportImage('png')" class="py-3 bg-gradient-to-br from-blue-600 to-blue-500 text-white font-bold text-xs rounded-lg shadow-lg hover:scale-[1.02] transition">PNG</button>
            <button onclick="exportImage('jpeg')" class="py-3 bg-gradient-to-br from-purple-600 to-purple-500 text-white font-bold text-xs rounded-lg shadow-lg hover:scale-[1.02] transition">JPG</button>
            <button onclick="exportImage('svg')" class="py-3 bg-gradient-to-br from-orange-500 to-red-500 text-white font-bold text-xs rounded-lg shadow-lg hover:scale-[1.02] transition">SVG</button>
            <button onclick="exportHTML()" class="py-3 bg-gradient-to-br from-emerald-600 to-emerald-500 text-white font-bold text-xs rounded-lg shadow-lg hover:scale-[1.02] transition" title="Download HTML Code"><i class="fas fa-code"></i></button>
        </div>

        <div class="sidebar-footer">
            <div class="flex gap-2 mt-2">
                <button onclick="cycleTheme()" class="btn-secondary flex-1 flex items-center justify-center gap-2 py-2 rounded text-xs transition">
                    <i class="fas fa-palette"></i> <span id="theme-label">Aurora</span>
                </button>
                <button onclick="openNewTabPreview()" class="btn-secondary flex-1 flex items-center justify-center gap-2 py-2 rounded text-xs transition">
                    <i class="fas fa-external-link-alt"></i> Preview
                </button>
            </div>
        </div>
    </div>

    <!-- Stage -->
    <div class="stage-container custom-scrollbar">
        <div id="render-wrapper">
            <div id="render-target" style="width: 1000px;">
                <!-- Content Injected Here -->
            </div>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud-toolbar">
        <button class="hud-btn" onclick="historyUndo()" title="Undo"><i class="fas fa-undo"></i></button>
        <button class="hud-btn" onclick="historyRedo()" title="Redo"><i class="fas fa-redo"></i></button>
        <div class="w-px h-6 bg-current opacity-20 mx-1"></div>
        <button class="hud-btn" onclick="triggerDuplicate()" title="Duplicate (Ctrl+D)"><i class="fas fa-clone"></i></button>
        <label class="hud-btn" title="Add Image"><i class="fas fa-image"></i><input type="file" accept="image/*" class="hidden-input" onchange="addImage(this)"></label>
        <div class="w-px h-6 bg-current opacity-20 mx-1"></div>
        <label class="hud-btn" title="Text Color"><i class="fas fa-font"></i><div class="absolute bottom-1 right-1 w-2 h-2 bg-current rounded-full border border-black/20"></div><input type="color" class="hidden-input" oninput="updateTextColor(this.value)"></label>
        <label class="hud-btn" title="Fill Color"><i class="fas fa-fill-drip"></i><div class="absolute bottom-1 right-1 w-2 h-2 bg-current rounded-full border border-black/20"></div><input type="color" class="hidden-input" oninput="updateFillColor(this.value)"></label>
        <button class="hud-btn" onclick="cycleFont()" title="Change Font"><i class="fas fa-paragraph"></i></button>
        <div class="w-px h-6 bg-current opacity-20 mx-1"></div>
        <div class="w-[100px] flex items-center px-1"><input type="range" id="edit-size-slider" min="0.2" max="3.0" step="0.1" value="1.0" oninput="updateElementSize(this.value)"></div>
        <div class="w-px h-6 bg-current opacity-20 mx-1"></div>
        <button class="hud-btn danger" onclick="deleteSelected()" title="Delete"><i class="fas fa-trash"></i></button>
    </div>

    <script>
        // --- FONT INJECTION HELPER ---
        let fontAwesomeBase64 = null;
        fetch('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2')
            .then(resp => resp.blob())
            .then(blob => {
                const reader = new FileReader();
                reader.onload = function() { fontAwesomeBase64 = reader.result; }
                reader.readAsDataURL(blob);
            });

        // --- NEXUS QUANTUM DASHBOARD DEMO ---
        const DEMO_HTML = `
<style>
    @keyframes spinGeo { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes wave { 0%, 100% { height: 10%; } 50% { height: 90%; } }
    @keyframes scanV { 0% { top: 0; } 100% { top: 100%; } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    @keyframes dashMove { to { stroke-dashoffset: 0; } }
    .glass-panel { background: rgba(17, 24, 39, 0.7); border: 1px solid rgba(56, 189, 248, 0.2); backdrop-filter: blur(10px); }
    .glass-panel:hover { border-color: rgba(56, 189, 248, 0.6); box-shadow: 0 0 20px rgba(56, 189, 248, 0.1); }
</style>

<div class="relative flex items-center justify-center h-[700px] bg-[#020617] font-mono p-8 overflow-hidden text-cyan-100" id="main-container">
    <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(circle, #1e293b 1px, transparent 1px); background-size: 30px 30px;"></div>
    <div class="absolute inset-0 bg-gradient-to-t from-[#020617] via-transparent to-[#020617]"></div>

    <div id="dashboard-frame" class="relative z-10 w-[1100px] h-[620px] bg-[#0f172a]/90 border border-slate-700 rounded-2xl shadow-2xl flex flex-col overflow-hidden ring-1 ring-white/10">

        <div class="h-16 border-b border-slate-800 bg-[#0B1121] flex items-center justify-between px-6">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 bg-cyan-600 rounded flex items-center justify-center text-white shadow-lg shadow-cyan-500/50"><i class="fas fa-cube"></i></div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-widest uppercase">NEXUS <span class="text-cyan-400">QUANTUM CORE</span></h1>
                    <p class="text-[10px] text-slate-500" id="sys-id">SYS_ID: LOADING...</p>
                </div>
            </div>
            <div class="flex gap-4 text-[10px] items-center">
                <!-- GAME BUTTON (Curiosity Trigger) -->
                <div id="btn-launch-game-internal" class="px-3 py-1 rounded bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 flex items-center gap-2 cursor-pointer hover:bg-cyan-500/20 hover:text-white transition group animate-[pulse_3s_infinite]" onclick="window.demoApp.launchGame()">
                    <i class="fas fa-exclamation-triangle text-lg group-hover:animate-bounce text-red-500"></i> <span class="hidden sm:inline text-red-400 font-bold tracking-widest">PROTOCOL: BREACH</span>
                </div>

                <div class="px-3 py-1 rounded bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 flex items-center gap-2">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> QUANTUM STABLE
                </div>
                <!-- REBOOT BUTTON -->
                <button onclick="window.demoApp.triggerReboot()" class="power-icon-pulse w-8 h-8 rounded-full bg-red-500/20 border border-red-500/50 flex items-center justify-center text-red-400 hover:bg-red-500 hover:text-white transition shadow-[0_0_10px_rgba(239,68,68,0.4)]">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>

        <!-- Grid Content -->
        <div class="flex-1 p-6 grid grid-cols-4 grid-rows-3 gap-4 overflow-hidden">

            <!-- 1. Quantum Core (2x2) -->
            <div class="glass-panel col-span-2 row-span-2 rounded-xl relative flex items-center justify-center overflow-hidden group">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(6,182,212,0.1),transparent)]"></div>
                <div class="w-64 h-64 border border-slate-700 rounded-full absolute animate-[spinGeo_20s_linear_infinite]"></div>
                <div class="w-52 h-52 border border-cyan-500/30 border-dashed rounded-full absolute animate-[spinGeo_15s_linear_infinite_reverse]"></div>
                <div class="w-40 h-40 border-2 border-cyan-400 rounded-full absolute animate-[spinGeo_8s_linear_infinite] border-t-transparent border-b-transparent"></div>

                <div class="z-10 text-center bg-black/50 backdrop-blur-sm p-4 rounded-full border border-white/10">
                    <div class="text-4xl font-bold text-white tracking-tighter" id="core-temp">48째C</div>
                    <div class="text-[9px] text-cyan-400 tracking-widest uppercase">Core Temp</div>
                </div>

                <div class="absolute bottom-4 right-4 text-right">
                    <div class="text-[10px] text-slate-500">Q-BITS</div>
                    <div class="text-xl font-bold text-white">1,024</div>
                </div>
            </div>

            <!-- 2. Qubit Coherence (Waveform) -->
            <div class="glass-panel col-span-1 row-span-1 rounded-xl p-4 flex flex-col relative overflow-hidden">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase"><i class="fas fa-wave-square mr-1 text-fuchsia-400"></i> Coherence</span>
                    <span class="text-[10px] text-fuchsia-400">99.9%</span>
                </div>
                <div class="flex-1 flex items-end gap-1 opacity-80">
                    <div class="w-1 bg-fuchsia-500 h-[40%] animate-[wave_1s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[70%] animate-[wave_1.2s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[50%] animate-[wave_0.8s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[80%] animate-[wave_1.5s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[60%] animate-[wave_1.1s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[90%] animate-[wave_1.3s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[40%] animate-[wave_0.9s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[70%] animate-[wave_1.4s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[50%] animate-[wave_1s_ease-in-out_infinite]"></div>
                    <div class="w-1 bg-fuchsia-500 h-[80%] animate-[wave_1.2s_ease-in-out_infinite]"></div>
                </div>
            </div>

            <!-- 3. Thermal Array -->
            <div class="glass-panel col-span-1 row-span-1 rounded-xl p-4 flex flex-col justify-between">
                <div class="flex justify-between mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase"><i class="fas fa-thermometer-half mr-1 text-orange-400"></i> Thermals</span>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center gap-2 text-[9px]"><span class="w-8 text-slate-500">ZONE A</span><div class="flex-1 h-1 bg-slate-800 rounded"><div class="h-full bg-gradient-to-r from-green-500 to-yellow-500 w-[40%]"></div></div><span class="text-white">34째</span></div>
                    <div class="flex items-center gap-2 text-[9px]"><span class="w-8 text-slate-500">ZONE B</span><div class="flex-1 h-1 bg-slate-800 rounded"><div class="h-full bg-gradient-to-r from-green-500 to-orange-500 w-[65%]"></div></div><span class="text-white">52째</span></div>
                    <div class="flex items-center gap-2 text-[9px]"><span class="w-8 text-slate-500">ZONE C</span><div class="flex-1 h-1 bg-slate-800 rounded"><div class="h-full bg-gradient-to-r from-green-500 to-yellow-500 w-[20%]"></div></div><span class="text-white">28째</span></div>
                </div>
            </div>

            <!-- 4. Network Topology -->
            <div class="glass-panel col-span-1 row-span-2 rounded-xl p-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle,rgba(59,130,246,0.1),transparent)]"></div>
                <div class="text-[10px] font-bold text-slate-400 uppercase mb-4"><i class="fas fa-network-wired mr-1 text-blue-400"></i> Topology</div>
                <div class="flex items-center justify-center h-[140px] relative">
                    <div class="absolute w-2 h-2 bg-white rounded-full top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 shadow-[0_0_10px_white]"></div>
                    <div class="absolute w-2 h-2 bg-blue-500 rounded-full top-10 left-10 animate-pulse"></div>
                    <div class="absolute w-2 h-2 bg-blue-500 rounded-full bottom-10 right-10 animate-pulse" style="animation-delay: 0.5s;"></div>
                    <div class="absolute w-2 h-2 bg-blue-500 rounded-full top-10 right-10 animate-pulse" style="animation-delay: 1s;"></div>
                    <svg class="absolute inset-0 w-full h-full pointer-events-none">
                        <line x1="50%" y1="50%" x2="25%" y2="25%" stroke="#3b82f6" stroke-width="1" opacity="0.5" />
                        <line x1="50%" y1="50%" x2="75%" y2="75%" stroke="#3b82f6" stroke-width="1" opacity="0.5" />
                        <line x1="50%" y1="50%" x2="75%" y2="25%" stroke="#3b82f6" stroke-width="1" opacity="0.5" />
                    </svg>
                </div>
            </div>

            <!-- 5. Event Log -->
            <div class="glass-panel col-span-2 row-span-1 rounded-xl p-3 font-mono text-[9px] text-slate-400 overflow-hidden relative">
                <div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-b from-[#111827] to-transparent z-10"></div>
                <div class="space-y-1 h-full overflow-y-auto no-scrollbar" id="event-log">
                    <div class="text-emerald-500">[10:42:01] SYS_INIT_COMPLETE</div>
                    <div>[10:42:02] Mounting file systems... OK</div>
                    <div>[10:42:05] Connecting to Quantum Cloud...</div>
                    <div class="text-blue-400">[10:42:08] Handshake successful. Encryption: AES-256-GCM</div>
                    <div class="text-yellow-500">[10:42:12] Warning: Minor variance in Qubit 42</div>
                    <div class="text-emerald-500 animate-pulse">[10:42:15] Auto-correction applied. Stability: 100%</div>
                </div>
            </div>

            <!-- 6. GPU Compute -->
            <div class="glass-panel col-span-1 row-span-1 rounded-xl p-4 flex items-center gap-4">
                <div class="relative w-12 h-12 flex items-center justify-center">
                    <svg class="w-full h-full -rotate-90"><circle cx="24" cy="24" r="20" stroke="#1e293b" stroke-width="4" fill="none"/><circle cx="24" cy="24" r="20" stroke="#8b5cf6" stroke-width="4" stroke-dasharray="125" stroke-dashoffset="40" fill="none" /></svg>
                    <div class="absolute text-[9px] font-bold text-white">72%</div>
                </div>
                <div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Tensor Load</div>
                    <div class="text-xs text-violet-400">RTX Acceleration</div>
                </div>
            </div>

            <!-- 7. Memory Matrix (New) -->
            <div class="glass-panel col-span-1 row-span-1 rounded-xl p-4">
                <div class="text-[10px] font-bold text-slate-400 uppercase mb-2"><i class="fas fa-memory mr-1 text-emerald-400"></i> Mem Matrix</div>
                <div class="grid grid-cols-10 gap-1 h-[40px]" id="mem-grid">
                    <!-- JS populates this -->
                </div>
            </div>

            <!-- 8. System Info (Bottom Bar) -->
            <div class="glass-panel col-span-4 row-span-1 h-10 rounded-lg flex items-center justify-between px-4 text-[10px] text-slate-500">
                <div class="flex gap-6">
                    <span><i class="fas fa-bolt text-yellow-500 mr-1"></i> 1.35 V</span>
                    <span><i class="fas fa-database text-blue-500 mr-1"></i> 42 PB Available</span>
                    <span><i class="fas fa-shield-alt text-emerald-500 mr-1"></i> Protected</span>
                </div>
                <div class="font-mono opacity-50">Create by Wasupon Srisatit, MD.</div>
            </div>

        </div>
    </div>

    <!-- CONFIRMATION MODAL (Initial) -->
    <div id="reboot-confirm" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-40 flex items-center justify-center hidden">
        <div class="bg-[#0f172a] border border-red-500/50 p-6 rounded-xl shadow-[0_0_50px_rgba(239,68,68,0.3)] text-center max-w-sm">
            <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center text-red-500 mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-xl"></i>
            </div>
            <h3 class="text-white font-bold text-lg mb-2">System Critical</h3>
            <p class="text-slate-400 text-xs mb-6">Initiating emergency reboot will purge all active quantum states. Are you sure?</p>
            <div class="flex gap-3 justify-center">
                <button onclick="window.demoApp.cancelReboot()" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-white text-xs">Cancel</button>
                <button onclick="window.demoApp.confirmReboot()" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500 text-white text-xs font-bold shadow-lg shadow-red-500/30">CONFIRM REBOOT</button>
            </div>
        </div>
    </div>
</div>`;

        const EMPTY_STATE_HTML = `
<div class="flex flex-col items-center justify-center h-[500px] transition-all duration-500" style="color:var(--text-muted)">
    <div class="empty-state-box mb-6">
        <i class="fas fa-pencil-alt text-4xl text-white"></i>
    </div>
    <h3 class="text-2xl font-bold mb-2" style="color:var(--text-main)">Ready to Create</h3>
    <p class="text-sm opacity-60">Type HTML code or Paste content to begin.</p>
</div>`;

        const input = document.getElementById('html-input');
        const renderTarget = document.getElementById('render-target');
        const hudToolbar = document.getElementById('hud-toolbar');
        const widthSlider = document.getElementById('width-slider');
        const editSizeSlider = document.getElementById('edit-size-slider');
        const btnView = document.getElementById('btn-view');
        const btnEdit = document.getElementById('btn-edit');

        let isEditMode = false;
        let selectedElement = null;
        let clipboardHTML = null; 
        let isDemoActive = true;
        let pasteCounter = 1;
        let memInterval;
        let gameInterval, gameTimerInterval;
        let gameScore = 0;
        let gameTime = 15;
        let decoyHits = 0;
        let decoyChance = 0.4;
        const MIN_WIN_SCORE = 1500;

        const themes = ['theme-aurora', 'theme-pearl', 'theme-obsidian'];
        const themeNames = ['Aurora', 'Pearl', 'Obsidian'];
        let themeIndex = 0;

        const fontFamilies = ["'Plus Jakarta Sans', sans-serif", "'JetBrains Mono', monospace", "'Playfair Display', serif", "'Caveat', cursive", "'Inter', sans-serif"];
        let fontIndex = 0;

        const historyStack = [];
        let historyPointer = -1;

        // --- GLOBAL DEMO APP CONTROLLER ---
        window.demoApp = {
            retryCount: 0, // Track number of retries

            initSys: function() {
                const log = renderTarget.querySelector('#event-log');
                if(log) {
                    log.innerHTML += `<div class="text-blue-400 animate-pulse">[${new Date().toLocaleTimeString()}] REBOOT SEQUENCE INITIATED...</div>`;
                    log.scrollTop = log.scrollHeight;
                }
            },
            triggerReboot: function(hardReset = false) {
                const modal = renderTarget.querySelector('#reboot-confirm');
                if(modal) modal.classList.add('hidden');

                const bootContainer = document.getElementById('global-boot-screen');
                const bsodScreen = document.getElementById('bsod-screen');
                const biosScreen = document.getElementById('bios-screen');
                const bootLog = document.getElementById('boot-log');
                const mainBody = document.body;

                const requestFS = document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen;
                if (requestFS) {
                    requestFS.call(document.documentElement).catch(err => { console.log("Fullscreen denied", err); });
                }

                // 1. GLITCH & INVERT
                mainBody.style.filter = "invert(1) hue-rotate(180deg)";
                mainBody.style.transform = "scale(1.02)";

                setTimeout(() => {
                    mainBody.style.filter = "none"; mainBody.style.transform = "none";
                    bootContainer.style.display = 'flex';
                    bsodScreen.style.display = 'flex';
                    bootContainer.style.zIndex = "999999999"; // Ensure top level

                    let percent = 0;
                    const progress = document.getElementById('bsod-progress');
                    const interval = setInterval(() => {
                        percent += Math.floor(Math.random() * 5);
                        if(percent > 100) percent = 100;
                        progress.innerText = percent;
                        if(percent === 100) clearInterval(interval);
                    }, 300);

                    setTimeout(() => {
                        bsodScreen.style.display = 'none';
                        setTimeout(() => {
                            biosScreen.style.display = 'block';
                            const logs = ["Initializing Nexus Kernel...", "Checking NVRAM... 64TB OK", "Mounting Volume /dev/quantum0... DONE", "Loading Graphics Subsystem... OK", "System Check: PASSED", "Booting Nexus OS..."];
                            bootLog.innerHTML = "";
                            let logDelay = 0;
                            logs.forEach(line => { setTimeout(() => { bootLog.innerHTML += `<div>${line}</div>`; }, logDelay); logDelay += Math.random() * 600 + 200; });
                            setTimeout(() => {
                                bootContainer.style.display = 'none'; biosScreen.style.display = 'none';

                                if (hardReset) {
                                    // HARD RESET LOGIC
                                    this.quitGame(); // Close game UI
                                    input.value = DEMO_HTML; // Reset Code
                                    renderContent(); // Re-render
                                    this.retryCount = 0; // Reset Flag

                                    // Reset Theme
                                    themeIndex = 0;
                                    document.body.className = themes[0];
                                    updateThemeUI();

                                    // Reset View Mode
                                    setMode('view');
                                }

                                if (document.exitFullscreen) document.exitFullscreen();
                                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                            }, logDelay + 1500);
                        }, 2000);
                    }, 5000);
                }, 500);
            },
            cancelReboot: function() {
                const modal = renderTarget.querySelector('#reboot-confirm');
                if(modal) modal.classList.add('hidden');
            },
            confirmReboot: function() {
                this.triggerReboot(false);
            },
            // GAME LOGIC
            launchGame: function(isRetry = false) {
                if (isRetry) {
                    this.retryCount++;
                } else {
                    this.retryCount = 0;
                }

                const gameScreen = document.getElementById('global-game-screen');
                const gameArea = document.getElementById('game-area');
                const scoreEl = document.getElementById('game-score');
                const timerEl = document.getElementById('game-timer');
                const failScreen = document.getElementById('global-fail-screen');
                const resultScreen = document.getElementById('game-result-screen');
                const briefingScreen = document.getElementById('game-briefing');
                const briefingCountdown = document.getElementById('briefing-countdown');

                const requestFS = document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen;
                if (requestFS) requestFS.call(document.documentElement).catch(() => {});

                gameScreen.style.display = 'block';
                failScreen.style.display = 'none';
                resultScreen.classList.add('hidden');
                gameArea.innerHTML = '';

                gameScore = 0;
                gameTime = 15;
                decoyHits = 0;
                decoyChance = 0.4; 
                scoreEl.innerText = "000";
                timerEl.innerText = "15";
                timerEl.className = "text-6xl font-black text-red-500 drop-shadow-[0_0_15px_rgba(239,68,68,0.8)]";
                document.getElementById('breach-bar').style.width = '0%';

                // SHOW BRIEFING
                briefingScreen.style.display = 'flex';
                let bCount = 3;
                briefingCountdown.innerText = bCount;
                const bInt = setInterval(() => {
                    bCount--;
                    if(bCount > 0) briefingCountdown.innerText = bCount;
                    else if (bCount === 0) briefingCountdown.innerText = "ENGAGE";
                    else {
                        clearInterval(bInt);
                        briefingScreen.style.display = 'none';
                        this.startGameLoop();
                    }
                }, 1000);
            },
            handleRetry: function() {
                // If we have already retried once (meaning we just finished Game 2), 
                // the next retry (Game 3) triggers revenge.
                if (this.retryCount >= 1) {
                    this.triggerWasuponRevenge();
                } else {
                    this.launchGame(true);
                }
            },
            handleFate: function() {
                // If we just finished Game 2, Fate also triggers revenge
                if (this.retryCount >= 1) {
                    this.triggerWasuponRevenge();
                } else {
                    this.triggerFailure();
                }
            },
            startGameLoop: function() {
                const gameArea = document.getElementById('game-area');
                const scoreEl = document.getElementById('game-score');
                const timerEl = document.getElementById('game-timer');
                const body = document.body;

                // Spawner
                gameInterval = setInterval(() => {
                    if(gameTime <= 0) return;

                    const rand = Math.random();

                    const target = document.createElement('div');

                    if(rand > 0.9) {
                        // BONUS (10% Chance)
                        target.className = 'bonus-target';
                        target.innerHTML = '<i class="fas fa-gem"></i>';

                    } else if (rand > 0.5) { // 40% Decoy
                        target.className = 'decoy-target';
                        target.innerHTML = '<i class="fas fa-bolt"></i>';

                    } else { // 50% Normal Target
                        target.className = 'game-target';
                        target.innerHTML = '<i class="fas fa-bug"></i>'; 
                        target.setAttribute('data-created', Date.now());
                        // Rotten Logic (Easier - 1.5s)
                        setTimeout(() => {
                            if(target.parentNode && !target.classList.contains('hit')) {
                                target.classList.add('rotten');
                                target.innerHTML = '<i class="fas fa-biohazard"></i>'; 
                            }
                        }, 1200); 
                    }

                    const x = Math.random() * (window.innerWidth - 90);
                    const y = Math.random() * (window.innerHeight - 160) + 90;
                    target.style.left = x + 'px'; target.style.top = y + 'px';

                    target.onmousedown = target.ontouchstart = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        const now = Date.now();

                        if(target.classList.contains('decoy-target')) {
                            decoyHits++;
                            document.getElementById('breach-bar').style.width = (decoyHits * 33.3) + '%';
                            body.classList.add('shake-screen');
                            setTimeout(() => body.classList.remove('shake-screen'), 300);
                            if(decoyHits >= 3) this.failGame();
                        } 
                        else if(target.classList.contains('bonus-target')) {
                            gameScore += 300;
                            scoreEl.innerText = gameScore.toString().padStart(3, '0');
                            target.classList.add('hit');
                        }
                        else {
                            const created = parseInt(target.getAttribute('data-created'));
                            if (now - created > 1500) { // Rotten
                                gameScore -= 50;
                                body.classList.add('shake-screen');
                                setTimeout(() => body.classList.remove('shake-screen'), 300);
                                // Penalty: More decoys
                                decoyChance = Math.min(0.8, decoyChance + 0.1);
                            } else {
                                gameScore += 100;
                                const p = document.createElement('div'); p.className = 'frag-particle';
                                p.style.left = (x+40)+'px'; p.style.top = (y+40)+'px';
                                p.style.setProperty('--tx', (Math.random()*100-50)+'px'); p.style.setProperty('--ty', (Math.random()*100-50)+'px');
                                gameArea.appendChild(p); setTimeout(() => p.remove(), 500);
                            }
                            scoreEl.innerText = gameScore.toString().padStart(3, '0');
                            target.classList.add('hit');
                        }
                        setTimeout(() => target.remove(), 200);
                    };

                    gameArea.appendChild(target);
                    setTimeout(() => { if(target.parentNode) target.remove(); }, 1400); // Easier - longer persist
                }, 300);

                // Timer & Panic
                gameTimerInterval = setInterval(() => {
                    gameTime--;
                    timerEl.innerText = gameTime;

                    if(gameTime < 6) timerEl.classList.add('timer-critical');

                    if(gameTime < 8 && Math.random() > 0.6) {
                         body.classList.add('red-shift');
                         setTimeout(() => body.classList.remove('red-shift'), 100);
                    }
                    // Fake System Fail Flash
                    if(gameTime < 5 && Math.random() > 0.7) {
                        const flash = document.createElement('div');
                        flash.className = 'absolute inset-0 flex items-center justify-center pointer-events-none z-50 text-6xl font-black text-red-500 opacity-80 animate-pulse';
                        flash.innerText = Math.random() > 0.5 ? "SYSTEM FAILURE" : "CRITICAL ERROR";
                        gameArea.appendChild(flash);
                        setTimeout(() => flash.remove(), 200);
                    }

                    if(gameTime <= 0) {
                        if(gameScore >= MIN_WIN_SCORE) this.winGame();
                        else this.failGame();
                    }
                }, 1000);
            },

            showResult: function(isWin) {
                clearInterval(gameInterval);
                clearInterval(gameTimerInterval);

                const showLeaderboard = () => {
                    const screen = document.getElementById('game-result-screen');
                    const title = document.getElementById('result-title');
                    const status = document.getElementById('core-status');
                    const btnRetry = document.getElementById('btn-retry');
                    const btnFate = document.getElementById('btn-fate');
                    const btnExit = document.getElementById('btn-exit');

                    screen.classList.remove('hidden');
                    generateLeaderboard(gameScore);

                    // Update Buttons to use new handlers
                    btnRetry.onclick = () => this.handleRetry();
                    btnFate.onclick = () => this.handleFate();

                    if(isWin) {
                        title.innerText = "BREACH SEALED";
                        title.className = "text-5xl font-black text-emerald-400 mb-2 animate-bounce";
                        status.innerText = "STABLE";
                        status.className = "text-emerald-400 font-bold";
                        btnRetry.classList.remove('hidden');
                        btnFate.classList.add('hidden');
                        btnExit.classList.remove('hidden');
                    } else {
                        title.innerText = "SYSTEM COMPROMISED";
                        title.className = "text-5xl font-black text-red-500 mb-2 panic-shake";
                        status.innerText = "CRITICAL";
                        status.className = "text-red-500 font-bold animate-pulse";
                        btnRetry.classList.remove('hidden');
                        btnFate.classList.remove('hidden');
                        btnExit.classList.add('hidden');
                    }
                };

                // UPDATED LOGIC: Trigger Taunt after Game 1 (retryCount === 0)
                if (this.retryCount === 0) {
                    this.triggerTaunt(showLeaderboard);
                } else {
                    showLeaderboard();
                }
            },

            // NEW TAUNT FUNCTION
            triggerTaunt: function(callback) {
                const overlay = document.createElement('div');
                overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:99999999;display:flex;flex-direction:column;align-items:center;justify-content:center;animation:fadeIn 0.3s;";

                overlay.innerHTML = `
                    <div class="text-6xl text-red-500 font-black mb-6 animate-bounce" style="text-shadow: 0 0 30px red; text-align:center;">"Nice try, loser."</div>
                    <div class="text-2xl text-slate-400 font-mono italic opacity-0" style="animation:fadeIn 1s 0.5s forwards;">- Dr. Wasupon</div>
                `;
                document.body.appendChild(overlay);

                setTimeout(() => {
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        overlay.remove();
                        callback();
                    }, 500);
                }, 2500);
            },

            winGame: function() { this.showResult(true); },
            failGame: function() { 
                this.showResult(false); 
            },

            triggerWasuponRevenge: function() {
                clearInterval(gameInterval);
                clearInterval(gameTimerInterval);
                document.getElementById('global-game-screen').style.display = 'none';

                const overlay = document.createElement('div');
                overlay.style.cssText = "position:fixed;inset:0;background:black;z-index:999999999;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;animation:fadeIn 0.5s;";

                overlay.innerHTML = `
                    <div style="color:#ef4444;font-size:1.5rem;margin-bottom:20px;letter-spacing:4px;" class="animate-pulse">ACCESS DENIED</div>
                    <div style="color:white;font-size:2.5rem;font-weight:900;text-align:center;margin-bottom:10px;text-shadow:0 0 20px red;">"Did you really think you could defeat me?"</div>
                    <div style="color:#94a3b8;font-size:1.2rem;margin-bottom:30px;font-style:italic;">"Know your place, user."</div>
                    <div style="color:#64748b;font-size:1rem;">- Dr. Wasupon</div>
                `;
                document.body.appendChild(overlay);

                setTimeout(() => {
                    overlay.remove();
                    this.triggerReboot(true); 
                }, 4000);
            },

            triggerFailure: function() {
                clearInterval(gameInterval);
                clearInterval(gameTimerInterval);
                document.getElementById('global-game-screen').style.display = 'none';

                const failScreen = document.getElementById('global-fail-screen');
                failScreen.style.display = 'flex';
                failScreen.style.zIndex = "99999999"; 

                const bar = document.getElementById('restore-bar');
                const log = document.getElementById('fail-log');
                bar.style.width = "0%";

                const logs = ["INITIATING EMERGENCY PURGE...", "ISOLATING KERNEL...", "FLUSHING MEMORY BANKS...", "RESTORING SAFE STATE..."];
                let i = 0;
                const logInt = setInterval(() => { if(i < logs.length) { log.innerText = logs[i]; i++; } }, 1200);
                setTimeout(() => { bar.style.width = "100%"; }, 100);

                setTimeout(() => {
                    clearInterval(logInt);
                    failScreen.style.display = 'none';

                    const biosScreen = document.getElementById('bios-screen');
                    const bootContainer = document.getElementById('global-boot-screen');
                    bootContainer.style.display = 'flex';
                    bootContainer.style.zIndex = "99999999";
                    biosScreen.style.display = 'block';

                    const bootLog = document.getElementById('boot-log');
                    const lines = ["SAFE MODE RECOVERY...", "Verifying Checksum... OK", "Restoring Graphic Config...", "System Stable."];
                    bootLog.innerHTML = "";
                    let d = 0;
                    lines.forEach(l => { setTimeout(() => bootLog.innerHTML += `<div>${l}</div>`, d); d += 500; });
                    setTimeout(() => {
                         bootContainer.style.display = 'none';
                         biosScreen.style.display = 'none';
                         this.quitGame();
                    }, d + 1000);
                }, 5000);
            },

            quitGame: function() {
                clearInterval(gameInterval);
                clearInterval(gameTimerInterval);
                document.getElementById('global-game-screen').style.display = 'none';
                document.body.classList.remove('red-shift');
                document.body.classList.remove('shake-screen');
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            }
        };

        function generateLeaderboard(score) {
            const names = ["Park", "Alex", "Sarah", "Mike", "Emily", "David", "Neo_Ops", "V0id_Walker"];
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';

            const playerRank = Math.random() > 0.5 ? 2 : 3;
            let entries = [];

            entries.push({ rank: 1, name: "Dr. Wasupon", score: (Math.floor((score + 500)/100)*100), isPlayer: false });

            const safeScore = Math.floor(score/100)*100;

            if (playerRank === 2) {
                entries.push({ rank: 2, name: "YOU", score: safeScore, isPlayer: true });
            } else {
                let r2Name = names[Math.floor(Math.random()*names.length)];
                entries.push({ rank: 2, name: r2Name, score: safeScore + 200, isPlayer: false });
            }

            if (playerRank === 3) {
                entries.push({ rank: 3, name: "YOU", score: safeScore, isPlayer: true });
            } else {
                let r3Name = names[Math.floor(Math.random()*names.length)];
                entries.push({ rank: 3, name: r3Name, score: Math.max(0, safeScore - 100), isPlayer: false });
            }

            entries.push({ rank: 4, name: names[Math.floor(Math.random()*names.length)], score: Math.max(0, safeScore - 400), isPlayer: false });
            entries.push({ rank: 5, name: names[Math.floor(Math.random()*names.length)], score: Math.max(0, safeScore - 800), isPlayer: false });

            entries.forEach(e => {
                const row = document.createElement('div');
                row.className = `flex justify-between items-center p-2 rounded ${e.isPlayer ? 'bg-cyan-900/50 border border-cyan-500/50 animate-pulse' : 'border-b border-slate-700/30'}`;
                let extra = "";
                if(e.isPlayer && score < MIN_WIN_SCORE) extra = " <span class='text-[10px] text-red-500 ml-1'>[KIA]</span>";
                if(e.rank === 1) extra = " <span class='text-[10px] text-yellow-500 ml-1'>[SURVIVOR]</span>";

                row.innerHTML = `<div class="flex items-center gap-3"><span class="${e.rank === 1 ? 'text-yellow-400 font-bold text-lg' : 'text-slate-500'}">#${e.rank}</span><span class="${e.isPlayer ? 'text-cyan-300 font-bold' : 'text-slate-300'}">${e.name}${extra}</span>${e.rank === 1 ? '<i class="fas fa-crown text-yellow-500 text-xs ml-1"></i>' : ''}</div><span class="text-emerald-400 font-mono">${e.score}</span>`;
                list.appendChild(row);
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            input.value = DEMO_HTML;
            renderContent();
            updateThemeUI();
            updateModeUI();

            setTimeout(() => {
                const sysId = renderTarget.querySelector('#sys-id');
                if(sysId) sysId.innerText = `SYS_ID: ${navigator.platform.toUpperCase()} // ${navigator.userAgent.split(' ')[0]}`;

                const grid = renderTarget.querySelector('#mem-grid');
                if(grid) {
                    let html = '';
                    for(let i=0; i<50; i++) {
                        const active = Math.random() > 0.3 ? 'bg-emerald-500/50' : 'bg-slate-700/30';
                        html += `<div class="w-full h-full rounded-[1px] ${active} transition-colors duration-300"></div>`;
                    }
                    grid.innerHTML = html;

                    if(memInterval) clearInterval(memInterval);
                    memInterval = setInterval(() => {
                        const cells = grid.children;
                        const idx = Math.floor(Math.random() * cells.length);
                        const cell = cells[idx];
                        if(cell) {
                            if(cell.classList.contains('bg-emerald-500/50')) { cell.classList.remove('bg-emerald-500/50'); cell.classList.add('bg-slate-700/30'); } 
                            else { cell.classList.remove('bg-slate-700/30'); cell.classList.add('bg-emerald-500/50'); }
                        }
                    }, 100);
                }
            }, 500);
        });

        function cycleTheme() {
            document.body.classList.remove(themes[themeIndex]);
            themeIndex = (themeIndex + 1) % themes.length;
            document.body.classList.add(themes[themeIndex]);
            updateThemeUI();
        }

        function updateThemeUI() {
            document.getElementById('theme-label').innerText = themeNames[themeIndex];
        }

        input.addEventListener('focus', () => {
            if (isDemoActive) {
                input.value = '';
                renderContent();
                saveState();
                isDemoActive = false;
            }
        });

        let renderTimeout;
        input.addEventListener('input', () => {
            if(isDemoActive) isDemoActive = false;
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => { renderContent(); saveState(); }, 600);
        });

        function renderContent() {
            const code = input.value;
            if (!code.trim()) {
                renderTarget.innerHTML = EMPTY_STATE_HTML;
                return;
            }
            const parser = new DOMParser();
            const doc = parser.parseFromString(code, 'text/html');
            let styles = "";
            doc.querySelectorAll('style').forEach(s => styles += s.outerHTML);
            renderTarget.innerHTML = styles + doc.body.innerHTML;

            if(window.FontAwesome) window.FontAwesome.dom.i2svg({ node: renderTarget });

            if (historyStack.length === 0) saveState();
            if (isEditMode) enableEditListeners();
        }

        function clearCode() { input.value = ''; renderContent(); saveState(); isDemoActive = false; }
        async function pasteCode() { try { input.value = await navigator.clipboard.readText(); renderContent(); saveState(); isDemoActive = false; } catch (e) { alert("Use Ctrl+V"); } }

        function setMode(mode) {
            isEditMode = (mode === 'edit');
            updateModeUI();
            if (isEditMode) { document.body.classList.add('editing-active'); hudToolbar.classList.add('visible'); enableEditListeners(); } 
            else { document.body.classList.remove('editing-active'); hudToolbar.classList.remove('visible'); deselectElement(); disableEditListeners(); }
        }

        function updateModeUI() {
            if (isEditMode) {
                btnEdit.className = "flex-1 py-2 text-xs font-bold rounded bg-slate-600 text-white shadow-inner transition-all";
                btnView.className = "flex-1 py-2 text-xs font-bold rounded text-slate-400 hover:bg-white/5 transition-all";
            } else {
                btnView.className = "flex-1 py-2 text-xs font-bold rounded bg-slate-600 text-white shadow-inner transition-all";
                btnEdit.className = "flex-1 py-2 text-xs font-bold rounded text-slate-400 hover:bg-white/5 transition-all";
            }
        }

        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 1500); }
        function triggerCopy() { if(selectedElement) { clipboardHTML = selectedElement.outerHTML; showToast("Element Copied"); } }
        function triggerPaste() {
            if(clipboardHTML) {
                const wrapper = document.createElement('div'); wrapper.innerHTML = clipboardHTML; const clone = wrapper.firstElementChild;
                clone.classList.remove('selected-element'); clone.classList.add('selectable-hover');
                const offset = pasteCounter * 20;
                clone.style.position = 'absolute'; clone.style.margin = '0'; clone.style.left = (50 + offset) + 'px'; clone.style.top = (50 + offset) + 'px'; clone.style.transform = 'none'; 
                renderTarget.appendChild(clone);
                if(isEditMode) { enableEditListeners(); selectElement(clone); }
                pasteCounter++; showToast("Pasted!"); saveState();
            }
        }
        function triggerDuplicate() { if(selectedElement) { clipboardHTML = selectedElement.outerHTML; triggerPaste(); } }

        function enableEditListeners() { 
            renderTarget.querySelectorAll('*').forEach(el => { 
                el.classList.add('selectable-hover'); 
                el.setAttribute('draggable', false); 
            }); 
            // Removed mousedown/touchstart here, handled by global handler
        }
        function disableEditListeners() { 
            renderTarget.querySelectorAll('*').forEach(el => { 
                el.classList.remove('selectable-hover', 'selected-element'); 
                el.contentEditable = "false"; 
            }); 
        }

        // --- MOBILE GESTURE CONTROLLER (UPDATED) ---
        const stageContainer = document.querySelector('.stage-container');
        const renderWrapper = document.getElementById('render-wrapper');

        // State for Pan/Zoom
        let gestureState = {
            scale: 1,
            panning: false,
            pointX: 0,
            pointY: 0,
            startX: 0,
            startY: 0,
            startDist: 0,
            lastScale: 1
        };

        function getDistance(touches) {
            return Math.hypot(
                touches[0].clientX - touches[1].clientX,
                touches[0].clientY - touches[1].clientY
            );
        }

        function getMidpoint(touches) {
            return {
                x: (touches[0].clientX + touches[1].clientX) / 2,
                y: (touches[0].clientY + touches[1].clientY) / 2
            };
        }

        stageContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault(); // Prevent default browser zoom
                gestureState.panning = true;

                // Disable transition for instant response
                renderWrapper.style.transition = 'none';

                // Calculate start values
                const mid = getMidpoint(e.touches);
                // We subtract pointX/Y to "pick up" where we left off
                gestureState.startX = mid.x - gestureState.pointX;
                gestureState.startY = mid.y - gestureState.pointY;
                gestureState.startDist = getDistance(e.touches);
                gestureState.lastScale = gestureState.scale;
            }
        }, { passive: false });

        stageContainer.addEventListener('touchmove', (e) => {
            if (gestureState.panning && e.touches.length === 2) {
                e.preventDefault();

                // 1. PANNING
                const mid = getMidpoint(e.touches);
                gestureState.pointX = mid.x - gestureState.startX;
                gestureState.pointY = mid.y - gestureState.startY;

                // 2. ZOOMING
                const dist = getDistance(e.touches);
                if (dist > 0 && gestureState.startDist > 0) {
                    const scaleChange = dist / gestureState.startDist;
                    // Limit zoom 0.5x to 3x
                    gestureState.scale = Math.min(Math.max(0.5, gestureState.lastScale * scaleChange), 3); 
                }

                // Apply Transform
                renderWrapper.style.transform = `translate(${gestureState.pointX}px, ${gestureState.pointY}px) scale(${gestureState.scale})`;
            }
        }, { passive: false });

        stageContainer.addEventListener('touchend', (e) => {
            if (e.touches.length < 2) {
                gestureState.panning = false;
                // Re-enable smooth transition for other operations
                renderWrapper.style.transition = 'transform 0.1s ease-out';
            }
        });

        // --- UNIFIED INPUT HANDLER (MOUSE & TOUCH) ---
        let isDragging = false; 
        let dragStartX, dragStartY, startMatrix;

        function handleInputStart(e) {
            if (!isEditMode) return;

            // UPDATED: Ignore multi-touch gestures for selection/dragging (let the stage handle pan/zoom)
            if (e.type === 'touchstart' && e.touches.length > 1) return;

            // Double Tap Detection for Touch
            if (e.type === 'touchstart') {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTouchTime;
                if (tapLength < 300 && tapLength > 0) {
                    // Double Tap
                    if (e.target !== renderTarget && !e.target.closest('input') && !e.target.closest('button')) {
                        e.stopPropagation();
                        selectElement(e.target, true); // Edit Mode
                        return;
                    }
                }
                lastTouchTime = currentTime;
            }

            if (e.target === renderTarget) { deselectElement(); return; }
            if (e.target.closest('input') || e.target.closest('button')) return;

            e.stopPropagation(); 

            // Single Click/Tap -> Select & Move
            selectElement(e.target, false); 
            isDragging = true;

            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; 
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            dragStartX = clientX; dragStartY = clientY;

            const style = window.getComputedStyle(selectedElement); 
            startMatrix = new WebKitCSSMatrix(style.transform);

            if (e.type === 'mousedown') { 
                document.addEventListener('mousemove', handleMove); 
                document.addEventListener('mouseup', handleEnd); 
            } else { 
                document.addEventListener('touchmove', handleMove, {passive: false}); 
                document.addEventListener('touchend', handleEnd); 
            }
        }

        // Attach Global Listeners to Render Target
        renderTarget.addEventListener('mousedown', handleInputStart);
        renderTarget.addEventListener('touchstart', handleInputStart, {passive: false});
        renderTarget.addEventListener('dblclick', (e) => {
             if (!isEditMode) return;
             if (e.target !== renderTarget && !e.target.closest('input')) {
                 e.stopPropagation();
                 selectElement(e.target, true);
             }
        });

        function handleMove(e) {
            if (!isDragging || !selectedElement) return; 
            e.preventDefault(); // Prevent scrolling while dragging

            // Safety check for touch events
            if (e.type.includes('touch') && (!e.touches || e.touches.length === 0)) return;

            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; 
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

            // CRITICAL FIX: Adjust delta by the current zoom scale
            const scale = gestureState.scale || 1;
            const deltaX = (clientX - dragStartX) / scale; 
            const deltaY = (clientY - dragStartY) / scale;

            selectedElement.style.transform = `translate(${startMatrix.m41 + deltaX}px, ${startMatrix.m42 + deltaY}px) scale(${startMatrix.m11})`;
        }
        function handleEnd() { 
            isDragging = false; 
            document.removeEventListener('mousemove', handleMove); 
            document.removeEventListener('mouseup', handleEnd); 
            document.removeEventListener('touchmove', handleMove); 
            document.removeEventListener('touchend', handleEnd); 
            saveState(); 
        }

        function selectElement(el, editMode = false) {
            if (selectedElement && selectedElement !== el) { 
                selectedElement.classList.remove('selected-element'); 
                selectedElement.contentEditable = "false"; 
            }
            selectedElement = el; 
            selectedElement.classList.add('selected-element');

            const style = window.getComputedStyle(selectedElement); 
            const matrix = new WebKitCSSMatrix(style.transform); 
            editSizeSlider.value = matrix.m11;

            if (editMode && el.childNodes.length === 1 && el.childNodes[0].nodeType === 3) { 
                el.contentEditable = "true"; 
                el.focus(); 
            } else {
                el.contentEditable = "false";
            }
        }

        function deselectElement() { if (selectedElement) { selectedElement.classList.remove('selected-element'); selectedElement.contentEditable = "false"; selectedElement = null; } }
        function deleteSelected() { if(selectedElement) { selectedElement.remove(); selectedElement=null; saveState(); } }
        function updateElementSize(val) { if (!selectedElement) return; const style = window.getComputedStyle(selectedElement); const matrix = new WebKitCSSMatrix(style.transform); selectedElement.style.transform = `translate(${matrix.m41}px, ${matrix.m42}px) scale(${val})`; }
        editSizeSlider.addEventListener('change', saveState);
        function updateTextColor(val) { if(selectedElement) { selectedElement.style.color = val; saveState(); } }
        function updateFillColor(val) { if(selectedElement) { if(selectedElement.tagName==='svg'||selectedElement.closest('svg')) selectedElement.style.fill=val; else selectedElement.style.backgroundColor=val; saveState(); } }
        function cycleFont() { if(selectedElement) { fontIndex = (fontIndex + 1) % fontFamilies.length; selectedElement.style.fontFamily = fontFamilies[fontIndex]; saveState(); } }
        function addImage(input) {
            if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = document.createElement('img'); img.src = e.target.result; img.style.width = "200px"; img.style.position = "absolute"; img.style.top = "100px"; img.style.left = "100px"; renderTarget.appendChild(img); if(isEditMode) selectElement(img); saveState(); input.value = ''; }; reader.readAsDataURL(input.files[0]); }
        }

        function saveState() { if (historyPointer < historyStack.length - 1) historyStack.splice(historyPointer + 1); historyStack.push(renderTarget.innerHTML); if(historyStack.length > 30) historyStack.shift(); else historyPointer++; }
        function historyUndo() { if(historyPointer > 0) { historyPointer--; renderTarget.innerHTML = historyStack[historyPointer]; if(isEditMode) enableEditListeners(); } }
        function historyRedo() { if(historyPointer < historyStack.length-1) { historyPointer++; renderTarget.innerHTML = historyStack[historyPointer]; if(isEditMode) enableEditListeners(); } }

        document.addEventListener('keydown', (e) => {
            if(document.activeElement === input) return;
            const isCtrl = e.ctrlKey || e.metaKey;
            if(isCtrl && e.key === 'z') { e.preventDefault(); historyUndo(); }
            if(isCtrl && e.key === 'y') { e.preventDefault(); historyRedo(); }
            if(isCtrl && e.key === 'd') { e.preventDefault(); triggerDuplicate(); }
            if(e.key === 'Delete') deleteSelected();
            if(isCtrl && e.key === 'c') { e.preventDefault(); triggerCopy(); }
            if(isCtrl && e.key === 'v') { e.preventDefault(); triggerPaste(); }
        });

        function autoFit() { renderTarget.style.width = 'fit-content'; const w = Math.max(800, Math.min(5000, renderTarget.scrollWidth)); renderTarget.style.width = `${w}px`; document.getElementById('width-slider').value = w; document.getElementById('width-val').innerText = `${w}px`; }
        document.getElementById('width-slider').addEventListener('input', (e) => { renderTarget.style.width = `${e.target.value}px`; document.getElementById('width-val').innerText = `${e.target.value}px`; });
        document.getElementById('quality-slider').addEventListener('input', (e) => { const k = parseInt(e.target.value); const pixels = k * 1000; document.getElementById('quality-val').innerText = `${k}K (${pixels}px)`; const warning = document.getElementById('resolution-warning'); if (k >= 10) warning.style.display = "flex"; else warning.style.display = "none"; });

        // *** EXPORT ENGINE: DEEP CLONE WITH DATA URI FONT ***
        function exportImage(format) {
            const wasEdit = isEditMode; if(wasEdit) setMode('view');
            const loader = document.getElementById('loading-overlay'); 
            document.getElementById('render-format-text').innerText = format.toUpperCase();
            loader.style.display='flex';

            // 1. Explicitly Construct Style Tag with FA Font
            const fontStyle = document.createElement('style');
            if (fontAwesomeBase64) {
                fontStyle.textContent = `@font-face { font-family: 'Font Awesome 6 Free'; font-style: normal; font-weight: 900; src: url(${fontAwesomeBase64}) format('woff2'); } .fas { font-family: 'Font Awesome 6 Free'; font-weight: 900; }`;
            }

            setTimeout(() => {
                const node = document.getElementById('render-target');
                const k = parseInt(document.getElementById('quality-slider').value);
                const targetWidth = k * 1000;
                const currentWidth = node.offsetWidth;
                const scale = targetWidth / currentWidth;

                // Clone and Prepare
                const clone = node.cloneNode(true);
                const container = document.createElement('div');
                container.style.width = `${node.offsetWidth}px`; container.style.height = `${node.offsetHeight}px`;
                container.style.position = 'absolute'; container.style.top = '-9999px'; container.style.left = '-9999px';
                container.style.transform = `scale(${scale})`; container.style.transformOrigin = 'top left';

                // INJECT FONTS INTO CLONE
                clone.appendChild(fontStyle);

                container.appendChild(clone);
                document.body.appendChild(container);

                const config = { width: targetWidth, height: node.offsetHeight * scale, style: { transform: `scale(${scale})`, transformOrigin: 'top left', width: `${node.offsetWidth}px`, height: `${node.offsetHeight}px` } };

                let promise;
                if (format === 'svg') promise = htmlToImage.toSvg(clone);
                else if (format === 'jpeg') promise = htmlToImage.toJpeg(clone, { ...config, quality: 0.95 });
                else promise = htmlToImage.toPng(clone, config);

                promise.then((dataUrl) => {
                    const link = document.createElement('a'); link.download = `HTMLme_Export_${k}K_${Date.now()}.${format==='svg'?'svg':(format==='jpeg'?'jpg':'png')}`; link.href = dataUrl; link.click();
                    document.body.removeChild(container); loader.style.display='none'; if(wasEdit) setMode('edit');
                }).catch((err) => { console.error(err); alert("Export Error"); document.body.removeChild(container); loader.style.display='none'; });
            }, 500);
        }

        // --- EXPORT HTML CODE ---
        function exportHTML() {
            const content = renderTarget.innerHTML;
            const width = renderTarget.style.width || '1000px';
            const height = renderTarget.offsetHeight + 'px';

            const fullHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Design Export</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0B0F19; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #design-container { position: relative; width: ${width}; height: ${height}; background: transparent; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        #design-container * { transform-origin: top left; }
    </style>
</head>
<body><div id="design-container">${content}</div></body></html>`;

            const blob = new Blob([fullHTML], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `nexus_export_${Date.now()}.html`; a.click();
        }

        function openNewTabPreview() {
            const w = window.open('', '_blank');
            const fonts = `<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@400;700&family=Caveat:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">`;
            w.document.write(`<html><head><title>HTML me! Preview</title><script src="https://cdn.tailwindcss.com"><\/script>${fonts}</head><body style="background:#e2e8f0;display:flex;justify-content:center;padding:40px"><div style="background:white;width:${renderTarget.style.width};min-height:100vh;box-shadow:0 10px 25px rgba(0,0,0,0.1);overflow:hidden;position:relative;">${renderTarget.innerHTML}</div></body></html>`);
            w.document.close();
        }
    </script>
</body>
</html>
